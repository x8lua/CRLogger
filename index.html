<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRLogger Pro üìù</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            background-image: url('https://raw.githubusercontent.com/x8lua/CRlogger/main/assets/bg.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-blend-mode: overlay;
            background-color: rgba(15, 23, 42, 0.5);
        }
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 60px rgba(59, 130, 246, 0.8); }
        }
        .fade-out {
            opacity: 0;
            transform: translateY(-20px) scale(0.9);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .visible-element {
            opacity: 1;
            pointer-events: auto;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .hidden-element {
            opacity: 0;
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .timetable-cell {
            transition: all 0.2s ease;
        }
        .timetable-cell:hover {
            transform: scale(1.02);
        }
        .timetable-cell.today {
            border-color: rgba(59, 130, 246, 0.8);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
        }
        .subject-gray {
            color: #ffffff;
            opacity: 0.5;
        }
        .subject-gray:hover {
            opacity: 0.8;
        }
        .subject-green {
            color: #22c55e;
        }
        .delete-pulse {
            animation: delete-pulse 0.5s ease-in-out;
        }
        @keyframes delete-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .table-scroll {
            overflow-x: auto;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 text-white font-sans" id="page">

    <!-- Logo Area - Middle Top -->
    <div class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center z-10" id="logoContainer">
        <img src="https://raw.githubusercontent.com/x8lua/CRlogger/main/assets/logo.png" alt="CRLogger Pro Logo" class="h-32 w-auto drop-shadow-2xl pulse-glow">
        <p class="text-xl font-mono tracking-widest text-blue-400 mt-4" id="time"></p>
    </div>

    <!-- Main Content - Hidden initially -->
    <div class="hidden-element w-full max-w-7xl mt-32" id="mainContent">
        <!-- Header -->
        <div class="glass rounded-2xl p-4 mb-4 text-center">
            <h1 class="text-2xl font-bold text-white">ËÅñËã•ÁëüÊïôÂçÄ‰∏≠Â≠∏Á¨¨‰∫îÊ†°Ôºà‰∏≠ÊñáÈÉ®Ôºâ</h1>
            <p class="text-white opacity-60 mt-1">2025-2026 Â≠∏Âπ¥ È´ò‰∏ÄÁî≤ Ë™≤Ë°®Ë®òÈåÑË°®</p>
        </div>

        <!-- Timetable -->
        <div class="glass rounded-2xl p-4 table-scroll">
            <table class="w-full min-w-[800px] text-sm">
                <thead>
                    <tr>
                        <th class="p-2 text-left text-white opacity-60 w-24">ÊôÇÈñì</th>
                        <th class="p-2 text-center text-white w-28">MON<br><span class="text-xs opacity-50">ÊòüÊúü‰∏Ä</span></th>
                        <th class="p-2 text-center text-white w-28">TUE<br><span class="text-xs opacity-50">ÊòüÊúü‰∫å</span></th>
                        <th class="p-2 text-center text-white w-28">WED<br><span class="text-xs opacity-50">ÊòüÊúü‰∏â</span></th>
                        <th class="p-2 text-center text-white w-28">THU<br><span class="text-xs opacity-50">ÊòüÊúüÂõõ</span></th>
                        <th class="p-2 text-center text-white w-28">FRI<br><span class="text-xs opacity-50">ÊòüÊúü‰∫î</span></th>
                    </tr>
                </thead>
                <tbody id="timetableBody">
                    <!-- Generated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Subject Edit Modal -->
    <div class="hidden-element fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" id="editModal">
        <div class="glass max-w-md w-full rounded-3xl p-6 shadow-2xl relative" onclick="event.stopPropagation()">
            <!-- Close Button -->
            <button id="editClose" class="absolute top-3 right-3 text-gray-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <!-- Header -->
            <div class="flex items-center gap-2 mb-4">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <h2 class="text-lg font-bold text-blue-400" id="editTitle">Subject</h2>
            </div>

            <!-- Subject Info -->
            <p class="text-gray-400 text-sm mb-4" id="editSubject">Monday - Period 1</p>

            <!-- Text Input -->
            <textarea id="editBox" 
                class="glow w-full h-40 bg-gray-900/50 border border-gray-700 rounded-2xl p-4 text-white outline-none transition-all placeholder-gray-600 resize-none"
                placeholder="Âñ∫Âë¢Â∫¶Ë®òÈåÑË™≤Â†ÇÈáçÈªû..."></textarea>

            <!-- MISS / HOLIDAY Toggle -->
            <div class="flex gap-2 mt-4">
                <button id="btnMiss" class="flex-1 py-2 rounded-xl border transition-all text-sm font-bold">MISS</button>
                <button id="btnHoliday" class="flex-1 py-2 rounded-xl border transition-all text-sm font-bold">HOLIDAY</button>
            </div>

            <!-- Confirm Button -->
            <button id="editConfirm" 
                class="mt-4 w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-2xl shadow-lg active:scale-95 transition-all">
                I Confirm
            </button>

            <!-- Delete Button -->
            <button id="editDelete" 
                class="mt-3 w-full bg-red-600/20 hover:bg-red-600/40 text-red-400 border border-red-600/50 font-bold py-3 rounded-2xl shadow-lg active:scale-95 transition-all hidden">
                üóëÔ∏è Delete (Click 3 times)
            </button>

            <!-- Delete Confirm Counter -->
            <p id="deleteCounter" class="text-center mt-2 text-sm text-gray-500 hidden">Click 0/3 to delete</p>

            <!-- Message -->
            <p id="editMsg" class="text-center mt-4 text-xs font-mono tracking-widest text-gray-500 uppercase"></p>
        </div>
    </div>

    <!-- Success Toast -->
    <div class="hidden-element fixed bottom-8 left-1/2 transform -translate-x-1/2 z-50" id="successToast">
        <div class="glass px-6 py-3 rounded-full shadow-2xl flex items-center gap-2">
            <span class="text-green-400">‚ú®</span>
            <span class="text-white font-bold" id="successText">SUCCESS</span>
        </div>
    </div>

    <script type="module">
        // GitHub Repository Assets URL
        const GITHUB_REPO = "https://raw.githubusercontent.com/x8lua/CRlogger/main";
        
        // Supabase Config
        const URL = "https://fgcahyuzvvralgvyaspo.supabase.co";
        const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZnY2FoeXV6dnZyYWxndnlhc3BvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyODQzMjAsImV4cCI6MjA4NTg2MDMyMH0.h0jZ3DYHgqo5J4us-gpmHGdpBgkVmFJG_svPqIBYIZI";

        // Time periods configuration
        const timePeriods = [
            { time: '08:25-09:05', period: 1, subjects: ['Á∂ìÊøü', 'Êï∏Â≠∏', 'Ëã±Êñá', '‰∏≠Êñá', 'Èü≥Ê®Ç/ÁæéÂãû'] },
            { time: '09:10-09:50', period: 2, subjects: ['Ëã±Êñá', 'Ëá™ÁÑ∂Âú∞ÁêÜ', 'Ëã±Êñá', 'Êï∏Â≠∏', 'Áè≠‰∏ª‰ªª'] },
            { time: '10:10-10:50', period: 3, subjects: ['Ëã±Êñá', '‰∏≠Êñá', '‰∏≠ÂúãÂè≤', 'Êï∏Â≠∏', 'Ëã±Êñá'] },
            { time: '10:55-11:35', period: 4, subjects: ['‰∏≠ÂúãÂè≤', '‰∏≠Êñá', 'Ëá™ÁÑ∂ÁßëÂ≠∏', 'Á∂ìÊøüËàáÊúÉË®à', 'Ë≥áË®ä'] },
            { time: '11:40-12:20', period: 5, subjects: ['‰∏≠Êñá', 'Ëã±Êñá', 'Ëá™ÁÑ∂ÁßëÂ≠∏', '‰∏≠ÂúãÂè≤', 'Ë≥áË®ä'] },
            { time: '14:00-14:40', period: 6, subjects: ['ÂÆóÊïô', 'Á∂ìÊøü', 'Êï∏Â≠∏', 'Ëã±Êñá', 'Êï∏Â≠∏'] },
            { time: '14:45-15:25', period: 7, subjects: ['ÂÆóÊïô', 'Âú∞ÁêÜ', '‰∏≠Êñá', 'È´îËÇ≤', 'Êï∏Â≠∏'] },
            { time: '15:30-16:10', period: 8, subjects: ['ÈôÑÂä†Êï∏Â≠∏', 'Ê≠∑Âè≤', 'È§òÊöáÊ¥ªÂãï', 'È´îËÇ≤', 'Ëá™ÁÑ∂Âú∞ÁêÜ'] },
            { time: '16:15-16:55', period: 9, subjects: ['---', '---', 'È§òÊöáÊ¥ªÂãï', '---', '---'] }
        ];

        // Special rows (break/recess)
        const specialRows = [
            { time: '08:00-08:25', label: 'Á•àÁ¶±/Êô®Á¶±', merged: true },
            { time: '09:05-09:10', label: 'Â∞èÊÅØ Break', merged: true },
            { time: '09:50-10:10', label: 'Â∞èÊÅØ Recess', merged: true },
            { time: '10:50-10:55', label: 'Â∞èÊÅØ Break', merged: true },
            { time: '11:35-11:40', label: 'Â∞èÊÅØ Break', merged: true },
            { time: '12:20-13:50', label: '‰∏≠Âçà Lunch', merged: true },
            { time: '13:50-14:00', label: 'ÂçàÁ¶±', merged: true },
            { time: '14:40-14:45', label: 'Â∞èÊÅØ Break', merged: true },
            { time: '15:25-15:30', label: 'Â∞èÊÅØ Break', merged: true }
        ];

        // Day-specific break rows (for 16:10-16:15)
        const daySpecificBreaks = [
            { time: '16:10-16:15', label: 'Â∞èÊÅØ Break', days: [1, 2] },  // Mon-Tue
            { time: '16:10-16:15', label: 'Â∞èÊÅØ Break', days: [4, 5] }   // Thu-Fri
        ];

        // State
        let currentDay = getHKToday();
        let editingSubject = null;
        let deleteClicks = 0;
        let currentStatus = ''; // '', 'miss', 'holiday'

        // DOM Elements
        const logoContainer = document.getElementById('logoContainer');
        const mainContent = document.getElementById('mainContent');
        const timetableBody = document.getElementById('timetableBody');
        const editModal = document.getElementById('editModal');
        const editClose = document.getElementById('editClose');
        const editTitle = document.getElementById('editTitle');
        const editSubject = document.getElementById('editSubject');
        const editBox = document.getElementById('editBox');
        const btnMiss = document.getElementById('btnMiss');
        const btnHoliday = document.getElementById('btnHoliday');
        const editConfirm = document.getElementById('editConfirm');
        const editDelete = document.getElementById('editDelete');
        const deleteCounter = document.getElementById('deleteCounter');
        const editMsg = document.getElementById('editMsg');
        const successToast = document.getElementById('successToast');
        const successText = document.getElementById('successText');
        const timeDisplay = document.getElementById('time');

        // Get today's index in Hong Kong timezone (GMT+8)
        function getHKToday() {
            const now = new Date();
            const hkTime = new Date(now.getTime() + (8 * 60 * 60 * 1000) - (now.getTimezoneOffset() * 60 * 1000));
            return hkTime.getDay();
        }

        // Update time display (GMT+8)
        function updateTime() {
            const now = new Date();
            const hkTime = new Date(now.getTime() + (8 * 60 * 60 * 1000) - (now.getTimezoneOffset() * 60 * 1000));
            const year = hkTime.getFullYear();
            const month = String(hkTime.getMonth() + 1).padStart(2, '0');
            const day = String(hkTime.getDate()).padStart(2, '0');
            const hours = String(hkTime.getHours()).padStart(2, '0');
            const minutes = String(hkTime.getMinutes()).padStart(2, '0');
            const seconds = String(hkTime.getSeconds()).padStart(2, '0');
            timeDisplay.innerText = `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
        }
        updateTime();
        setInterval(updateTime, 1000);

        // Generate unique ID for a subject
        function getSubjectId(dayIndex, period) {
            return `day_${dayIndex}_period_${period}`;
        }

        // Get data from Supabase
        async function loadData() {
            const data = {};
            try {
                const res = await fetch(`${URL}/rest/v1/logs?select=*`, {
                    headers: {
                        'apikey': KEY,
                        'Authorization': `Bearer ${KEY}`
                    }
                });
                const records = await res.json();
                records.forEach(record => {
                    data[record.id] = record;
                });
            } catch (e) {
                console.error('Failed to load data:', e);
            }
            return data;
        }

        // Save data to Supabase
        async function saveData(subjectId, content, dayIndex, period, status) {
            const res = await fetch(`${URL}/rest/v1/logs`, {
                method: 'POST',
                headers: {
                    'apikey': KEY,
                    'Authorization': `Bearer ${KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify({
                    id: subjectId,
                    content: content,
                    day_index: dayIndex,
                    period: period,
                    status: status
                })
            });
            return res.ok;
        }

        // Delete data from Supabase
        async function deleteData(subjectId) {
            const res = await fetch(`${URL}/rest/v1/logs?id=eq.${subjectId}`, {
                method: 'DELETE',
                headers: {
                    'apikey': KEY,
                    'Authorization': `Bearer ${KEY}`
                }
            });
            return res.ok;
        }

        // Render the timetable
        async function renderTimetable() {
            const data = await loadData();
            timetableBody.innerHTML = '';

            const dayNames = ['MON', 'TUE', 'WED', 'THU', 'FRI'];
            const dayNamesZH = ['ÊòüÊúü‰∏Ä', 'ÊòüÊúü‰∫å', 'ÊòüÊúü‰∏â', 'ÊòüÊúüÂõõ', 'ÊòüÊúü‰∫î'];

            // Combine and sort all rows by start time
            const allRows = [];
            
            // Add merged break rows (apply to all days)
            specialRows.forEach(row => {
                const startTime = row.time.split('-')[0];
                allRows.push({
                    type: 'break',
                    time: row.time,
                    label: row.label,
                    merged: true,
                    days: [1, 2, 3, 4, 5],
                    startTime: parseTime(startTime)
                });
            });

            // Add period rows
            timePeriods.forEach(period => {
                const startTime = period.time.split('-')[0];
                allRows.push({
                    type: 'period',
                    time: period.time,
                    period: period.period,
                    subjects: period.subjects,
                    startTime: parseTime(startTime)
                });
            });

            // Sort by start time
            allRows.sort((a, b) => a.startTime - b.startTime);

            // Render all rows
            allRows.forEach(row => {
                if (row.type === 'break' && row.merged) {
                    // Render merged break row
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-2 text-left text-white text-xs opacity-60">${row.time}</td>
                        <td colspan="5" class="p-2 text-center text-white text-sm font-light opacity-50">${row.label}</td>
                    `;
                    timetableBody.appendChild(tr);
                } else if (row.type === 'break' && !row.merged) {
                    // Render day-specific break row
                    const tr = document.createElement('tr');
                    let cellsHTML = '';
                    
                    for (let dayIndex = 1; dayIndex <= 5; dayIndex++) {
                        if (row.days.includes(dayIndex)) {
                            cellsHTML += `<td class="p-2 text-center text-white text-sm font-light opacity-50 border border-gray-700/50 rounded-lg">${row.label}</td>`;
                        } else {
                            cellsHTML += `<td class="p-2 border border-transparent"></td>`;
                        }
                    }
                    
                    tr.innerHTML = `
                        <td class="p-2 text-left text-white text-xs opacity-60">${row.time}</td>
                        ${cellsHTML}
                    `;
                    timetableBody.appendChild(tr);
                } else {
                    // Render period row
                    const tr = document.createElement('tr');
                    
                    // Time column
                    const timeTd = document.createElement('td');
                    timeTd.className = 'p-2 text-left text-white text-xs whitespace-nowrap';
                    timeTd.innerHTML = `${row.time}<br><span class="text-white opacity-50 text-xs">Á¨¨${row.period}ÁØÄ</span>`;
                    tr.appendChild(timeTd);

                    // Day columns (1-5 = Mon-Fri)
                    for (let dayIndex = 1; dayIndex <= 5; dayIndex++) {
                        const subjectName = row.subjects[dayIndex - 1];
                        
                        // Check if this is the ‰ΩôÊöáÊ¥ªÂãï cell that should span (Wednesday, period 8)
                        const isWednesday = dayIndex === 3;
                        const isLeisureCell = subjectName === 'È§òÊöáÊ¥ªÂãï';
                        const isPeriod8 = row.period === 8;
                        const shouldMerge = isWednesday && isLeisureCell && isPeriod8;
                        
                        // Skip if this cell should be merged (period 9 Wednesday)
                        if (isWednesday && row.period === 9 && subjectName === 'È§òÊöáÊ¥ªÂãï') {
                            continue;
                        }
                        
                        const subjectId = getSubjectId(dayIndex, row.period);
                        const record = data[subjectId];
                        const hasContent = record && record.content && record.content.trim();
                        const status = record?.status || '';
                        const isToday = dayIndex === currentDay;
                        
                        const cell = document.createElement('td');
                        cell.className = `p-1 timetable-cell border border-gray-700/50 rounded-lg ${isToday ? 'today' : ''}`;
                        if (shouldMerge) {
                            cell.setAttribute('rowspan', '2');
                        }
                        
                        // Check if unclickable (---)
                        const isUnclickable = subjectName === '---';
                        
                        let statusClass = 'subject-gray';
                        let statusText = '‚óã';
                        
                        if (!isUnclickable) {
                            if (status === 'miss') {
                                statusClass = 'text-red-400';
                                statusText = 'MISS';
                            } else if (status === 'holiday') {
                                statusClass = 'text-green-400';
                                statusText = 'HOLIDAY';
                            } else if (hasContent) {
                                statusClass = 'subject-green';
                                statusText = '‚úì';
                            }
                        }

                        if (isUnclickable) {
                            cell.innerHTML = `
                                <div class="text-center p-1 opacity-30">
                                    <div class="text-sm text-white">${subjectName}</div>
                                </div>
                            `;
                        } else {
                            cell.innerHTML = `
                                <div class="text-center p-1 cursor-pointer hover:bg-white/10 rounded-lg transition-all"
                                     onclick="openEditModal(${dayIndex}, ${row.period}, '${subjectName}')">
                                    <div class="text-sm ${statusClass}">${subjectName}</div>
                                    <div class="text-xs ${statusClass} mt-1">${statusText}</div>
                                </div>
                            `;
                        }
                        tr.appendChild(cell);
                    }

                    timetableBody.appendChild(tr);
                }
            });
        }

        // Helper function to parse time string to minutes
        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // Open edit modal
        window.openEditModal = async function(dayIndex, period, subjectName) {
            const dayNames = ['MON', 'TUE', 'WED', 'THU', 'FRI'];
            const dayNamesZH = ['ÊòüÊúü‰∏Ä', 'ÊòüÊúü‰∫å', 'ÊòüÊúü‰∏â', 'ÊòüÊúüÂõõ', 'ÊòüÊúü‰∫î'];
            
            editingSubject = { dayIndex, period, subjectName };
            deleteClicks = 0;
            currentStatus = '';
            
            const data = await loadData();
            const subjectId = getSubjectId(dayIndex, period);
            const record = data[subjectId];
            const hasContent = record && record.content && record.content.trim();

            editTitle.textContent = subjectName;
            editSubject.textContent = `${dayNamesZH[dayIndex - 1]} (${dayNames[dayIndex - 1]}) - Á¨¨ ${period} ÁØÄ`;
            editBox.value = hasContent ? record.content : '';
            
            // Set status
            currentStatus = record?.status || '';
            updateStatusButtons();

            // Show/hide delete button based on content
            if (hasContent || currentStatus) {
                editDelete.classList.remove('hidden');
                deleteCounter.classList.add('hidden');
            } else {
                editDelete.classList.add('hidden');
                deleteCounter.classList.add('hidden');
            }
            
            editMsg.innerText = '';
            editModal.classList.remove('hidden-element');
            editModal.classList.add('visible-element');
            editBox.focus();
        };

        // Update status buttons appearance
        function updateStatusButtons() {
            if (currentStatus === 'miss') {
                btnMiss.className = 'flex-1 py-2 rounded-xl border border-red-500 bg-red-500/20 text-red-400 transition-all text-sm font-bold';
                btnHoliday.className = 'flex-1 py-2 rounded-xl border border-gray-700 bg-gray-800/50 text-gray-500 transition-all text-sm font-bold';
            } else if (currentStatus === 'holiday') {
                btnMiss.className = 'flex-1 py-2 rounded-xl border border-gray-700 bg-gray-800/50 text-gray-500 transition-all text-sm font-bold';
                btnHoliday.className = 'flex-1 py-2 rounded-xl border border-green-500 bg-green-500/20 text-green-400 transition-all text-sm font-bold';
            } else {
                btnMiss.className = 'flex-1 py-2 rounded-xl border border-gray-700 bg-gray-800/50 text-gray-400 transition-all text-sm font-bold';
                btnHoliday.className = 'flex-1 py-2 rounded-xl border border-gray-700 bg-gray-800/50 text-gray-400 transition-all text-sm font-bold';
            }
        }

        // Status button handlers
        btnMiss.onclick = () => {
            currentStatus = currentStatus === 'miss' ? '' : 'miss';
            updateStatusButtons();
        };

        btnHoliday.onclick = () => {
            currentStatus = currentStatus === 'holiday' ? '' : 'holiday';
            updateStatusButtons();
        };

        // Close edit modal
        function closeEditModal() {
            editModal.classList.remove('visible-element');
            editModal.classList.add('hidden-element');
            editingSubject = null;
            deleteClicks = 0;
        }

        editClose.onclick = closeEditModal;

        // Close modal on outside click
        editModal.onclick = (e) => {
            if (e.target === editModal) closeEditModal();
        };

        // Close modal on Escape
        document.onkeydown = (e) => {
            if (e.key === 'Escape') closeEditModal();
        };

        // Confirm / Submit
        editConfirm.onclick = async () => {
            const content = editBox.value.trim();
            const { dayIndex, period, subjectName } = editingSubject;
            const subjectId = getSubjectId(dayIndex, period);

            if (!content && !currentStatus) {
                editMsg.innerText = "Ë´ãËº∏ÂÖ•ÂÖßÂÆπÊàñÈÅ∏Êìá MISS/HOLIDAY";
                return;
            }

            editConfirm.disabled = true;
            editConfirm.classList.add('opacity-50');
            editMsg.innerText = "üì° Uplinking...";

            try {
                const success = await saveData(subjectId, content, dayIndex, period, currentStatus);
                if (success) {
                    editMsg.innerText = "‚ú® SUCCESS";
                    editConfirm.disabled = false;
                    editConfirm.classList.remove('opacity-50');
                    
                    // Show success toast
                    successText.textContent = 'SUCCESS';
                    successToast.classList.remove('hidden-element');
                    successToast.classList.add('visible-element');
                    
                    // Close modal and refresh
                    setTimeout(() => {
                        closeEditModal();
                        successToast.classList.remove('visible-element');
                        successToast.classList.add('hidden-element');
                        renderTimetable();
                    }, 1000);
                } else {
                    editMsg.innerText = "‚ùå Error";
                    editConfirm.disabled = false;
                    editConfirm.classList.remove('opacity-50');
                }
            } catch (e) {
                editMsg.innerText = "‚ùå Connection Failed";
                editConfirm.disabled = false;
                editConfirm.classList.remove('opacity-50');
            }
        };

        // Delete button click
        editDelete.onclick = () => {
            deleteClicks++;
            deleteCounter.classList.remove('hidden');
            deleteCounter.textContent = `Click ${deleteClicks}/3 to delete`;
            editDelete.classList.add('delete-pulse');
            
            setTimeout(() => editDelete.classList.remove('delete-pulse'), 500);

            if (deleteClicks >= 3) {
                deleteSubject();
            }
        };

        // Delete subject
        async function deleteSubject() {
            const { dayIndex, period } = editingSubject;
            const subjectId = getSubjectId(dayIndex, period);
            
            editDelete.disabled = true;
            editDelete.classList.add('opacity-50');
            editMsg.innerText = "üóëÔ∏è Deleting...";

            try {
                const success = await deleteData(subjectId);
                if (success) {
                    editMsg.innerText = "‚ú® DELETED";
                    
                    // Show success toast
                    successText.textContent = 'DELETED';
                    successToast.classList.remove('hidden-element');
                    successToast.classList.add('visible-element');
                    
                    // Close modal and refresh
                    setTimeout(() => {
                        closeEditModal();
                        successText.textContent = 'SUCCESS';
                        successToast.classList.remove('visible-element');
                        successToast.classList.add('hidden-element');
                        renderTimetable();
                    }, 1000);
                } else {
                    editMsg.innerText = "‚ùå Delete Failed";
                    deleteClicks = 0;
                    deleteCounter.classList.add('hidden');
                    editDelete.disabled = false;
                    editDelete.classList.remove('opacity-50');
                }
            } catch (e) {
                editMsg.innerText = "‚ùå Error";
                deleteClicks = 0;
                deleteCounter.classList.add('hidden');
                editDelete.disabled = false;
                editDelete.classList.remove('opacity-50');
            }
        }

        // Click anywhere to show timetable
        document.body.onclick = (e) => {
            if (e.target.closest('#editModal')) return;
            if (e.target.closest('.timetable-cell')) return;
            
            if (!mainContent.classList.contains('visible-element')) {
                logoContainer.classList.add('fade-out');
                setTimeout(() => {
                    logoContainer.classList.add('hidden-element');
                    mainContent.classList.remove('hidden-element');
                    mainContent.classList.add('visible-element');
                }, 300);
            }
        };

        // Initial render
        renderTimetable();
    </script>
</body>
</html>
