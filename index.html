<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>CRLogger Pro üìù</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chiron+Sung+HK:ital,wght@0,200..900;1,200..900&family=Google+Sans:ital,opsz,wght@0,17..18,400..700;1,17..18,400..700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body {
            overflow-x: hidden;
            overscroll-behavior: none;
        }
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            background-image: url('https://raw.githubusercontent.com/x8lua/CRlogger/main/assets/bg.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-blend-mode: overlay;
            background-color: rgba(15, 23, 42, 0.5);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .panel {
            background: #ffffff;
            border: 0.7px solid #000000;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            box-shadow: none;
            color: #000000;
            font-family: 'KaiTi', 'STKaiti', 'Ê®ôÊ•∑È´î', serif;
        }
        .panel * {
            font-family: inherit;
        }
        .panel .text-white,
        .panel .text-gray-400,
        .panel .text-gray-300,
        .panel .text-gray-200,
        .panel .text-blue-400,
        .panel .text-green-400,
        .panel .text-red-400,
        .panel .text-red-300,
        .panel .text-red-200 {
            color: #000000 !important;
        }
        .panel .subject-gray,
        .panel .subject-green {
            color: #000000 !important;
            opacity: 1;
        }
        .panel .text-xs {
            font-size: 0.95rem !important;
        }
        .panel .text-sm {
            font-size: 1.05rem !important;
        }
        .panel .text-base {
            font-size: 1.15rem !important;
        }
        .panel .text-lg {
            font-size: 1.35rem !important;
        }
        .panel .text-xl {
            font-size: 1.55rem !important;
        }
        .panel .text-2xl {
            font-size: 1.85rem !important;
        }
        .panel td,
        .panel th,
        .panel .timetable-cell {
            border-color: #000000 !important;
            border-width: 0.8px !important;
        }
        .panel .timetable-cell.today {
            border-color: #000000 !important;
            box-shadow: none !important;
        }
        #mainContent .timetable-cell:hover {
            transform: none !important;
        }
        #mainContent .panel,
        #mainContent .panel * {
            font-family: 'KaiTi', 'STKaiti', 'KaiTi TC', 'DFKai-SB', 'Ê®ôÊ•∑È´î', serif !important;
        }
        #mainContent .subject-gray,
        #mainContent .subject-green,
        #mainContent .text-red-400,
        #mainContent .text-green-400,
        #mainContent .text-blue-400,
        #mainContent .text-gray-300,
        #mainContent .text-gray-400,
        #mainContent .text-white {
            color: #000000 !important;
            opacity: 1 !important;
        }
        #mainContent .table-scroll table {
            font-size: 1.08rem !important;
        }
        #mainContent .subject-name {
            font-size: 1.3rem !important;
            line-height: 1.2 !important;
            font-weight: 700 !important;
            color: #000000 !important;
            text-rendering: geometricPrecision;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        #mainContent .subject-status {
            font-size: 1.02rem !important;
            line-height: 1.2 !important;
            color: #000000 !important;
            text-rendering: geometricPrecision;
        }
        #mainContent .subject-time {
            font-size: 0.96rem !important;
            line-height: 1.2 !important;
        }
        /* Mobile optimizations */
        @media (max-width: 640px) {
            #mainContent .subject-name {
                font-size: 0.7rem !important;
                line-height: 1.1 !important;
            }
            #mainContent .subject-status {
                font-size: 0.65rem !important;
            }
            .panel .text-xs {
                font-size: 0.65rem !important;
            }
            .timetable-cell {
                min-height: 40px !important;
                padding: 2px !important;
            }
        }
        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 60px rgba(59, 130, 246, 0.8); }
        }
        .fade-out {
            opacity: 0;
            transform: translateY(-20px) scale(0.9);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .visible-element {
            opacity: 1;
            pointer-events: auto;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .hidden-element {
            opacity: 0;
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .timetable-cell {
            transition: all 0.2s ease;
        }
        .timetable-cell:hover {
            transform: scale(1.02);
        }
        .timetable-cell.today {
            border-color: rgba(59, 130, 246, 0.8);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
        }
        .subject-gray {
            color: #ffffff;
            opacity: 0.5;
        }
        .subject-gray:hover {
            opacity: 0.8;
        }
        .subject-green {
            color: #22c55e;
        }
        .delete-pulse {
            animation: delete-pulse 0.5s ease-in-out;
        }
        @keyframes delete-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
.table-scroll {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    /* Center merged cells vertically */
    td[rowspan] {
        vertical-align: middle;
    }
    /* Leisure activity merged cell */
    .leisure-cell {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        min-height: 60px;
    }
        /* Mobile-optimized tap targets */
        @media (max-width: 640px) {
            body {
                /* Avoid mobile drag/parallax effect from fixed backgrounds */
                background-attachment: scroll;
                background-size: cover;
                background-position: center center;
            }
            button {
                min-height: 44px;
                min-width: 44px;
            }
            .timetable-cell {
                min-height: 60px;
            }
        }
        /* Prevent text selection on mobile */
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        /* Smooth touch interactions */
        .touch-optimized {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2 sm:p-4 text-white font-sans no-select" id="page">

    <!-- Logo Area - Middle Top -->
    <div class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center z-10" id="logoContainer">
        <img src="https://raw.githubusercontent.com/x8lua/CRlogger/main/assets/logo.png" alt="CRLogger Pro Logo" class="w-64 sm:w-72 md:w-80 lg:w-96 h-auto max-w-[85vw] object-contain drop-shadow-2xl pulse-glow">
        <p class="text-base sm:text-xl font-mono tracking-widest text-blue-400 mt-2 sm:mt-4" id="time"></p>
    </div>

    <!-- Main Content - Hidden initially -->
    <div class="hidden-element w-full max-w-7xl mt-24 sm:mt-28 md:mt-32 px-1 sm:px-2" id="mainContent">
        <!-- Changelog Button - Top Right -->
        <button id="changelogBtn" onclick="openChangelog()" class="fixed top-4 right-4 z-40 px-4 py-2 bg-white hover:bg-gray-50 text-black font-bold rounded-lg shadow-md border border-gray-300 transition-all touch-optimized text-sm" style="font-family: 'Google Sans', sans-serif;">
            üìù CHANGELOG
        </button>

        <!-- Week Navigation -->
        <div class="panel rounded-xl sm:rounded-2xl p-2 sm:p-3 mb-3 sm:mb-4 flex flex-col sm:flex-row items-center justify-between gap-2 sm:gap-4">
            <div class="flex gap-2 w-full sm:w-auto">
                <button id="prevWeek" class="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-gray-700/50 hover:bg-gray-600/50 rounded-lg sm:rounded-xl text-white font-bold transition-all touch-optimized text-sm sm:text-base">
                    ‚óÄ <span class="hidden xs:inline">‰∏ä‰∏ÄÈÄ±</span><span class="xs:hidden">‰∏äÈÄ±</span>
                </button>
                <button id="nextWeek" class="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-gray-700/50 hover:bg-gray-600/50 rounded-lg sm:rounded-xl text-white font-bold transition-all touch-optimized text-sm sm:text-base">
                    <span class="hidden xs:inline">‰∏ã‰∏ÄÈÄ±</span> ‚ñ∂
                </button>
            </div>
            <div class="text-center">
                <h2 id="weekLabel" class="text-base sm:text-lg font-bold text-blue-400">Êú¨Âë®</h2>
                <p id="weekDates" class="text-xs sm:text-sm text-gray-400 mt-0.5 sm:mt-1">Feb 3 - Feb 9, 2026</p>
            </div>
        </div>

        <!-- Header -->
        <div class="panel rounded-xl sm:rounded-2xl p-3 sm:p-4 mb-3 sm:mb-4 text-center">
            <h1 class="text-lg sm:text-2xl font-bold text-white">ËÅñËã•ÁëüÊïôÂçÄ‰∏≠Â≠∏Á¨¨‰∫îÊ†°Ôºà‰∏≠ÊñáÈÉ®Ôºâ</h1>
            <p class="text-white opacity-60 mt-1 text-sm sm:text-base">2025-2026 Â≠∏Âπ¥ È´ò‰∏ÄÁî≤ Ë™≤Ë°®Ë®òÈåÑË°®</p>
        </div>

        <!-- Timetable -->
        <div class="panel rounded-xl sm:rounded-2xl p-2 sm:p-4 table-scroll">
            <!-- Mobile Day Selector -->
            <div class="sm:hidden mb-3">
                <button id="lostDayBtn" onclick="handleLostDayAction()" class="w-full py-2 px-3 rounded-lg text-sm font-bold bg-red-600/30 hover:bg-red-600/50 text-red-300 border border-red-500/40 touch-optimized">
                    LOST
                </button>
                <div class="mt-2 flex gap-1 overflow-x-auto pb-2 no-scrollbar">
                    <button onclick="showDay(1)" class="day-btn flex-1 py-2 px-3 rounded-lg text-sm font-bold bg-blue-600 text-white" data-day="1">MON</button>
                    <button onclick="showDay(2)" class="day-btn flex-1 py-2 px-3 rounded-lg text-sm font-bold bg-gray-700/50 text-gray-400" data-day="2">TUE</button>
                    <button onclick="showDay(3)" class="day-btn flex-1 py-2 px-3 rounded-lg text-sm font-bold bg-gray-700/50 text-gray-400" data-day="3">WED</button>
                    <button onclick="showDay(4)" class="day-btn flex-1 py-2 px-3 rounded-lg text-sm font-bold bg-gray-700/50 text-gray-400" data-day="4">THU</button>
                    <button onclick="showDay(5)" class="day-btn flex-1 py-2 px-3 rounded-lg text-sm font-bold bg-gray-700/50 text-gray-400" data-day="5">FRI</button>
                </div>
            </div>
            <div class="hidden sm:flex mb-3 items-center justify-between gap-2">
                <div class="flex gap-1">
                    <button onclick="setLostTargetDay(1)" class="lost-target-btn px-3 py-1.5 rounded-lg text-xs font-bold bg-gray-700/50 text-gray-300 border border-gray-600/60" data-lost-day="1">MON</button>
                    <button onclick="setLostTargetDay(2)" class="lost-target-btn px-3 py-1.5 rounded-lg text-xs font-bold bg-gray-700/50 text-gray-300 border border-gray-600/60" data-lost-day="2">TUE</button>
                    <button onclick="setLostTargetDay(3)" class="lost-target-btn px-3 py-1.5 rounded-lg text-xs font-bold bg-gray-700/50 text-gray-300 border border-gray-600/60" data-lost-day="3">WED</button>
                    <button onclick="setLostTargetDay(4)" class="lost-target-btn px-3 py-1.5 rounded-lg text-xs font-bold bg-gray-700/50 text-gray-300 border border-gray-600/60" data-lost-day="4">THU</button>
                    <button onclick="setLostTargetDay(5)" class="lost-target-btn px-3 py-1.5 rounded-lg text-xs font-bold bg-gray-700/50 text-gray-300 border border-gray-600/60" data-lost-day="5">FRI</button>
                </div>
                <button id="lostDayBtnDesktop" onclick="handleLostDayAction()" class="py-1.5 px-4 rounded-lg text-sm font-bold bg-red-600/30 hover:bg-red-600/50 text-red-300 border border-red-500/40 touch-optimized">
                    LOST
                </button>
            </div>
            
            <table class="w-full text-sm sm:text-base">
                <thead class="hidden sm:table-header-group">
                    <tr>
                        <th class="p-1.5 sm:p-2 text-left text-white opacity-60 w-20 sm:w-24 text-xs">ÊôÇÈñì</th>
                        <th class="p-1.5 sm:p-2 text-center text-white w-20 sm:w-28">MON<br><span class="text-xs opacity-50 hidden sm:inline">ÊòüÊúü‰∏Ä</span></th>
                        <th class="p-1.5 sm:p-2 text-center text-white w-20 sm:w-28">TUE<br><span class="text-xs opacity-50 hidden sm:inline">ÊòüÊúü‰∫å</span></th>
                        <th class="p-1.5 sm:p-2 text-center text-white w-20 sm:w-28">WED<br><span class="text-xs opacity-50 hidden sm:inline">ÊòüÊúü‰∏â</span></th>
                        <th class="p-1.5 sm:p-2 text-center text-white w-20 sm:w-28">THU<br><span class="text-xs opacity-50 hidden sm:inline">ÊòüÊúüÂõõ</span></th>
                        <th class="p-1.5 sm:p-2 text-center text-white w-20 sm:w-28">FRI<br><span class="text-xs opacity-50 hidden sm:inline">ÊòüÊúü‰∫î</span></th>
                    </tr>
                </thead>
                <tbody id="timetableBody">
                    <!-- Generated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Mobile Day View Modal -->
    <div id="dayViewModal" class="hidden-element fixed inset-0 bg-black/80 backdrop-blur-sm z-50 p-4 overflow-y-auto">
        <div class="panel rounded-2xl p-4 min-h-[80vh]">
            <div class="flex items-center justify-between mb-4">
                <h2 id="dayViewTitle" class="text-xl font-bold text-blue-400">Monday</h2>
                <button onclick="closeDayView()" class="p-2 text-gray-400 hover:text-white touch-optimized">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="dayViewContent" class="space-y-2">
                <!-- Generated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Subject Edit Modal -->
    <div class="hidden-element fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center z-50 p-2 sm:p-4" id="editModal">
        <div class="bg-white max-w-lg w-full rounded-2xl sm:rounded-3xl p-4 sm:p-6 shadow-2xl relative max-h-[90vh] sm:max-h-[80vh] overflow-y-auto border-2 border-black" onclick="event.stopPropagation()" style="font-family: 'Chiron Sung HK', sans-serif;">
            <!-- Close Button -->
            <button id="editClose" class="absolute top-2 right-2 sm:top-3 sm:right-3 p-2 text-black hover:text-gray-600 transition-colors touch-optimized z-10">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <!-- Header -->
            <div class="flex items-center gap-2 mb-3 sm:mb-4 pr-8">
                <div class="w-2 h-2 bg-black rounded-full"></div>
                <h2 class="text-lg sm:text-xl font-bold text-black" id="editTitle" style="font-family: 'Chiron Sung HK', sans-serif;">Subject</h2>
            </div>

            <!-- Subject Info -->
            <p class="text-black text-sm mb-3 sm:mb-4 opacity-70" id="editSubject" style="font-family: 'Chiron Sung HK', sans-serif;">Monday - Period 1</p>

            <!-- Text Input -->
            <textarea id="editBox"
                class="w-full h-28 sm:h-40 bg-white border-2 border-black rounded-xl sm:rounded-2xl p-3 sm:p-4 text-black outline-none transition-all resize-none text-sm sm:text-base placeholder-gray-400"
                placeholder="Âñ∫Âë¢Â∫¶Ë®òÈåÑË™≤Â†ÇÈáçÈªû..." style="font-family: 'Chiron Sung HK', sans-serif;"></textarea>

            <!-- MISS Toggle -->
            <div class="mt-3 sm:mt-4">
                <button id="btnMiss" class="w-full py-2.5 sm:py-3 rounded-xl border-2 border-black transition-all text-sm sm:text-base font-bold touch-optimized bg-white text-black hover:bg-gray-100" style="font-family: 'Chiron Sung HK', sans-serif;">MISS</button>
            </div>

            <!-- Confirm Button -->
            <button id="editConfirm"
                class="mt-4 w-full bg-black hover:bg-gray-800 text-white font-bold py-3 sm:py-4 rounded-xl sm:rounded-2xl shadow-lg active:scale-95 transition-all text-sm sm:text-base touch-optimized" style="font-family: 'Chiron Sung HK', sans-serif;">
                I Confirm
            </button>

            <!-- Delete Button -->
            <button id="editDelete"
                class="mt-3 w-full bg-white hover:bg-red-50 text-red-600 border-2 border-red-600 font-bold py-3 sm:py-4 rounded-xl sm:rounded-2xl shadow-lg active:scale-95 transition-all text-sm sm:text-base touch-optimized hidden" style="font-family: 'Chiron Sung HK', sans-serif;">
                üóëÔ∏è Delete (Click 3 times)
            </button>

            <!-- Delete Confirm Counter -->
            <p id="deleteCounter" class="text-center mt-2 text-sm text-black hidden" style="font-family: 'Chiron Sung HK', sans-serif;">Click 0/3 to delete</p>

            <!-- Message -->
            <p id="editMsg" class="text-center mt-3 sm:mt-4 text-xs sm:text-sm tracking-widest text-black uppercase" style="font-family: 'KaiTi', 'STKaiti', 'Ê®ôÊ•∑È´î', serif;"></p>
        </div>
    </div>

    <!-- Success Toast -->
    <div class="hidden-element fixed bottom-4 sm:bottom-8 left-1/2 transform -translate-x-1/2 z-50 px-4" id="successToast">
        <div class="panel px-4 sm:px-6 py-2.5 sm:py-3 rounded-full shadow-2xl flex items-center gap-2">
            <span class="text-green-400 text-lg sm:text-xl">‚ú®</span>
            <span class="text-white font-bold text-sm sm:text-base" id="successText">SUCCESS</span>
        </div>
    </div>

    <!-- LOST Warning Modal -->
    <div id="lostWarnModal" class="hidden-element fixed inset-0 bg-black/80 backdrop-blur-sm z-50 p-4 flex items-center justify-center">
        <div class="panel w-full max-w-md rounded-2xl p-5 sm:p-6">
            <h3 class="text-xl font-bold text-red-300">Warning</h3>
            <p id="lostWarnText" class="mt-3 text-sm sm:text-base text-gray-200"></p>
            <p id="lostWarnCountdown" class="mt-2 text-xs sm:text-sm text-red-200"></p>
            <div class="mt-5 grid grid-cols-2 gap-2">
                <button id="lostWarnCancelBtn" class="py-2.5 rounded-xl border border-gray-600 bg-gray-800/70 text-gray-200 font-bold touch-optimized">Cancel</button>
                <button id="lostWarnConfirmBtn" class="py-2.5 rounded-xl border border-red-500/70 bg-red-600/30 text-red-200 font-bold touch-optimized opacity-60" disabled>Confirm LOST</button>
            </div>
        </div>
    </div>

    <!-- Changelog Modal -->
    <div id="changelogModal" class="hidden-element fixed inset-0 bg-black/90 backdrop-blur-md z-50 p-4 overflow-y-auto">
        <div class="max-w-2xl mx-auto my-8">
            <!-- Header -->
            <div class="bg-white rounded-t-2xl p-6 relative border-b-2 border-gray-200">
                <button onclick="closeChangelog()" class="absolute top-4 right-4 p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-all touch-optimized">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <h2 class="text-2xl font-bold text-black mb-1" style="font-family: 'Google Sans', sans-serif;">üìù CHANGELOG</h2>
                <p class="text-gray-600 text-sm" style="font-family: 'Google Sans', sans-serif;">CRLogger Pro Development History</p>
            </div>

            <!-- Content -->
            <div class="bg-white rounded-b-2xl p-6 shadow-2xl" style="font-family: 'Google Sans', sans-serif;">
                <!-- Version 1.1 -->
                <div class="mb-6 pb-6 border-b border-gray-200">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="px-3 py-1 bg-black text-white text-sm font-bold rounded-md">v1.1</span>
                        <span class="text-gray-500 text-sm">2025/2/6 23:30</span>
                        <span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs font-bold rounded">Latest</span>
                    </div>
                    <h3 class="text-lg font-bold text-black mb-2">Redesigned for School Official Schedule Paper Look</h3>
                    <ul class="space-y-1.5 text-black text-sm">
                        <li class="flex items-start gap-2">
                            <span class="mt-0.5">‚Ä¢</span>
                            <span>White panel design mimicking official school schedule paper</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="mt-0.5">‚Ä¢</span>
                            <span>KaiTi font for authentic Chinese document appearance</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="mt-0.5">‚Ä¢</span>
                            <span>Black borders and clean typography</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="mt-0.5">‚Ä¢</span>
                            <span>Tick background for completed lessons</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="mt-0.5">‚Ä¢</span>
                            <span>Bilingual labels (Chinese/English)</span>
                        </li>
                    </ul>
                </div>

                <!-- Version 1.0.0 -->
                <div class="mb-6">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="px-3 py-1 bg-gray-800 text-white text-sm font-bold rounded-md">v1.0.0</span>
                        <span class="text-gray-500 text-sm">2025/2/6 01:00</span>
                    </div>
                    <h3 class="text-lg font-bold text-black mb-2">CRLogger Has Created</h3>
                    <ul class="space-y-1.5 text-black text-sm mb-3">
                        <li class="flex items-start gap-2">
                            <span class="mt-0.5">‚Ä¢</span>
                            <span>Basic features work for Friday</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="mt-0.5">‚Ä¢</span>
                            <span>Weekly timetable with navigation</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="mt-0.5">‚Ä¢</span>
                            <span>Subject editing and note-taking</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="mt-0.5">‚Ä¢</span>
                            <span>Cloud sync with Supabase</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="mt-0.5">‚Ä¢</span>
                            <span>Mobile-responsive design</span>
                        </li>
                    </ul>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-sm text-gray-700">
                        <span class="font-bold">üíú Developer Note:</span> Stayed up till 1 AM to make the feature work properly for Friday
                    </div>
                </div>

                <!-- Footer -->
                <div class="text-center pt-4 border-t border-gray-200">
                    <p class="text-gray-600 text-sm">Made with ‚ù§Ô∏è for ËÅñËã•ÁëüÊïôÂçÄ‰∏≠Â≠∏Á¨¨‰∫îÊ†°</p>
                    <p class="text-gray-400 text-xs mt-1">CRLogger Pro ¬© 2025-2026</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // GitHub Repository Assets URL
        const GITHUB_REPO = "https://raw.githubusercontent.com/x8lua/CRlogger/main";
        
        // Supabase Config
        const URL = "https://fgcahyuzvvralgvyaspo.supabase.co";
        const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZnY2FoeXV6dnZyYWxndnlhc3BvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyODQzMjAsImV4cCI6MjA4NTg2MDMyMH0.h0jZ3DYHgqo5J4us-gpmHGdpBgkVmFJG_svPqIBYIZI";

        // Time periods configuration
        const timePeriods = [
            { time: '08:25-09:05', period: 1, subjects: ['Á∂ìÊøü', 'Êï∏Â≠∏', 'Ëã±Êñá', '‰∏≠Êñá', 'Èü≥Ê®Ç/ÁæéÂãû'] },
            { time: '09:10-09:50', period: 2, subjects: ['Ëã±Êñá', 'Ëá™ÁÑ∂Âú∞ÁêÜ', 'Ëã±Êñá', 'Êï∏Â≠∏', 'Áè≠‰∏ª‰ªª'] },
            { time: '10:10-10:50', period: 3, subjects: ['Ëã±Êñá', '‰∏≠Êñá', '‰∏≠ÂúãÂè≤', 'Êï∏Â≠∏', 'Ëã±Êñá'] },
            { time: '10:55-11:35', period: 4, subjects: ['‰∏≠ÂúãÂè≤', '‰∏≠Êñá', 'Ëá™ÁÑ∂ÁßëÂ≠∏', 'Á∂ìÊøüËàáÊúÉË®à', 'Ë≥áË®ä'] },
            { time: '11:40-12:20', period: 5, subjects: ['‰∏≠Êñá', 'Ëã±Êñá', 'Ëá™ÁÑ∂ÁßëÂ≠∏', '‰∏≠ÂúãÂè≤', 'Ë≥áË®ä'] },
            { time: '14:00-14:40', period: 6, subjects: ['ÂÆóÊïô', 'Á∂ìÊøü', 'Êï∏Â≠∏', 'Ëã±Êñá', 'Êï∏Â≠∏'] },
            { time: '14:45-15:25', period: 7, subjects: ['ÂÆóÊïô', 'Âú∞ÁêÜ', '‰∏≠Êñá', 'È´îËÇ≤', 'Êï∏Â≠∏'] },
            { time: '15:30-16:10', period: 8, subjects: ['ÈôÑÂä†Êï∏Â≠∏', 'Ê≠∑Âè≤', 'È§òÊöáÊ¥ªÂãï', 'È´îËÇ≤', 'Ëá™ÁÑ∂Âú∞ÁêÜ'] },
            { time: '16:15-16:55', period: 9, subjects: ['---', '---', 'È§òÊöáÊ¥ªÂãï<br>(17:10ÊîæÂ≠∏)', '---', '‰∏≠Êñá'] }
        ];

// Special rows (break/recess)
    const specialRows = [
        { time: '08:00-08:25', label: 'Á•àÁ¶± Prayer<br>Áè≠Âãô Morning Assembly', merged: true, align: 'middle' },
        { time: '09:05-09:10', label: 'Â∞è‰ºë Break', merged: true, align: 'middle' },
        { time: '09:50-10:10', label: 'Â∞èÊÅØ Recess', merged: true, align: 'middle' },
        { time: '10:50-10:55', label: 'Â∞è‰ºë Break', merged: true, align: 'middle' },
        { time: '11:35-11:40', label: 'Â∞è‰ºë Break', merged: true, align: 'middle' },
        { time: '12:20-13:50', label: '‰∏≠Âçà Lunch', merged: true, align: 'middle' },
        { time: '13:50-14:00', label: 'ÂçàÁ¶±', merged: true, align: 'middle' },
        { time: '14:40-14:45', label: 'Â∞è‰ºë Break', merged: true, align: 'middle' },
        { time: '15:25-15:30', label: 'Â∞è‰ºë Break', merged: true, align: 'middle' }
    ];

// Day-specific break rows (for 16:10-16:15)
    const daySpecificBreaks = [];

        // State
        let editingSubject = null;
        let deleteClicks = 0;
        let currentStatus = '';
        let currentMobileDay = null;
        let cachedData = {};
        let lostWarningDay = null;
        let lostReadyAt = 0;
        let lostReadyTimer = null;
        let selectedLostDay = null;
        let isApplyingLost = false;

        // DOM Elements
        const logoContainer = document.getElementById('logoContainer');
        const mainContent = document.getElementById('mainContent');
        const timetableBody = document.getElementById('timetableBody');
        const editModal = document.getElementById('editModal');
        const editClose = document.getElementById('editClose');
        const editTitle = document.getElementById('editTitle');
        const editSubject = document.getElementById('editSubject');
        const editBox = document.getElementById('editBox');
        const btnMiss = document.getElementById('btnMiss');
        const lostDayBtn = document.getElementById('lostDayBtn');
        const lostDayBtnDesktop = document.getElementById('lostDayBtnDesktop');
        const lostWarnModal = document.getElementById('lostWarnModal');
        const lostWarnText = document.getElementById('lostWarnText');
        const lostWarnCountdown = document.getElementById('lostWarnCountdown');
        const lostWarnCancelBtn = document.getElementById('lostWarnCancelBtn');
        const lostWarnConfirmBtn = document.getElementById('lostWarnConfirmBtn');
        const editConfirm = document.getElementById('editConfirm');
        const editDelete = document.getElementById('editDelete');
        const deleteCounter = document.getElementById('deleteCounter');
        const editMsg = document.getElementById('editMsg');
        const successToast = document.getElementById('successToast');
        const successText = document.getElementById('successText');
        const timeDisplay = document.getElementById('time');
        const prevWeekBtn = document.getElementById('prevWeek');
        const nextWeekBtn = document.getElementById('nextWeek');
        const weekLabel = document.getElementById('weekLabel');
        const weekDates = document.getElementById('weekDates');
        const dayViewModal = document.getElementById('dayViewModal');
        const dayViewTitle = document.getElementById('dayViewTitle');
        const dayViewContent = document.getElementById('dayViewContent');
        const lostTargetBtns = Array.from(document.querySelectorAll('.lost-target-btn'));

        // Week navigation state
        let weekOffset = 0;
        const dayShortNames = ['MON', 'TUE', 'WED', 'THU', 'FRI'];

        // Check if mobile view
        function isMobile() {
            return window.innerWidth < 640;
        }

        // Get HK date parts (year, month, day) for a given date in Asia/Hong_Kong
        function getHKDateParts(d) {
            const f = new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Hong_Kong', year: 'numeric', month: '2-digit', day: '2-digit' });
            const parts = f.formatToParts(d);
            const get = (k) => parseInt(parts.find(p => p.type === k).value, 10);
            return { year: get('year'), month: get('month'), day: get('day') };
        }

        // Get HK today (day of week 0‚Äì6) with week offset
        function getHKToday() {
            const { year, month, day } = getHKDateParts(new Date());
            const d = new Date(Date.UTC(year, month - 1, day + (weekOffset * 7)));
            return d.getUTCDay();
        }

        // Get HK date with week offset (UTC-midnight Date for that calendar day, for week math)
        function getHKDate() {
            const { year, month, day } = getHKDateParts(new Date());
            const d = new Date(Date.UTC(year, month - 1, day + (weekOffset * 7)));
            return d;
        }

        // Get current day index with week offset
        function getCurrentDayWithOffset() {
            const hkDate = getHKDate();
            return hkDate.getUTCDay();
        }

        // Update week label
        function updateWeekLabel() {
            const hkDate = getHKDate();
            const currentDay = hkDate.getUTCDay();

            const monday = new Date(Date.UTC(hkDate.getUTCFullYear(), hkDate.getUTCMonth(), hkDate.getUTCDate() - currentDay + 1));
            const sunday = new Date(Date.UTC(hkDate.getUTCFullYear(), hkDate.getUTCMonth(), hkDate.getUTCDate() - currentDay + 7));

            const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            const startStr = `${monthNames[monday.getUTCMonth()]} ${monday.getUTCDate()}`;
            const endStr = `${monthNames[sunday.getUTCMonth()]} ${sunday.getUTCDate()}`;
            const yearStr = sunday.getUTCFullYear();

            if (weekOffset === 0) {
                weekLabel.textContent = 'Êú¨Âë®';
            } else if (weekOffset === 1) {
                weekLabel.textContent = '‰∏ã‰∏ÄÈÄ±';
            } else if (weekOffset === -1) {
                weekLabel.textContent = '‰∏ä‰∏ÄÈÄ±';
            } else if (weekOffset > 0) {
                weekLabel.textContent = `+${weekOffset} ÈÄ±`;
            } else {
                weekLabel.textContent = `${weekOffset} ÈÄ±`;
            }

            weekDates.textContent = `${startStr} - ${endStr}, ${yearStr}`;

            prevWeekBtn.disabled = weekOffset <= -52;
            nextWeekBtn.disabled = weekOffset >= 52;
            prevWeekBtn.classList.toggle('opacity-50', weekOffset <= -52);
            nextWeekBtn.classList.toggle('opacity-50', weekOffset >= 52);
        }

        // Navigate to previous week
        prevWeekBtn.onclick = () => {
            weekOffset--;
            updateWeekLabel();
            renderTimetable();
        };

        // Navigate to next week
        nextWeekBtn.onclick = () => {
            weekOffset++;
            updateWeekLabel();
            renderTimetable();
        };

        // Update time display (Asia/Hong_Kong)
        function updateTime() {
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('zh-HK', {
                timeZone: 'Asia/Hong_Kong',
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                hour12: false
            });
            const parts = formatter.formatToParts(now);
            const get = (k) => parts.find(p => p.type === k).value;
            timeDisplay.innerText = `${get('year')}/${get('month')}/${get('day')} ${get('hour')}:${get('minute')}:${get('second')}`;
        }
        updateTime();
        setInterval(updateTime, 1000);

        function getSubjectId(dayIndex, period) {
            return `week_${weekOffset}_day_${dayIndex}_period_${period}`;
        }

        function getSubjectNameForDay(periodConfig, dayIndex) {
            // Hard-map period 9 to prevent Thu/Fri column drift.
            if (periodConfig.period === 9) {
                const period9Map = {
                    1: '---',
                    2: '---',
                    3: 'È§òÊöáÊ¥ªÂãï',
                    4: '---',
                    5: '‰∏≠Êñá'
                };
                return period9Map[dayIndex];
            }
            return periodConfig.subjects[dayIndex - 1];
        }

        // Get data from Supabase
        async function loadData() {
            const data = {};
            try {
                console.log('Loading data from Supabase...');
                const res = await fetch(`${URL}/rest/v1/logs?select=*`, {
                    headers: {
                        'apikey': KEY,
                        'Authorization': `Bearer ${KEY}`
                    }
                });
                console.log('Load response status:', res.status);
                const records = await res.json();
                console.log('Loaded records:', records.length);
                records.forEach(record => {
                    data[record.session_id] = record;
                });
            } catch (e) {
                console.error('Failed to load data:', e);
            }
            return data;
        }

        // Save data to Supabase
        async function saveData(subjectId, content, dayIndex, period, status) {
            console.log('Attempting to save:', { subjectId, content, status });

            if (!content && !status) {
                console.log('No content or status to save');
                return true;
            }

            try {
                console.log('Deleting existing record...');
                const deleteRes = await fetch(`${URL}/rest/v1/logs?session_id=eq.${subjectId}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': KEY,
                        'Authorization': `Bearer ${KEY}`
                    }
                });
                console.log('Delete response status:', deleteRes.status);

                const saveData = {
                    session_id: subjectId,
                    content: content
                };

                if (dayIndex) saveData.day_index = dayIndex;
                if (period) saveData.period = period;
                if (status) saveData.status = status;

                console.log('Sending data:', saveData);

                const res = await fetch(`${URL}/rest/v1/logs`, {
                    method: 'POST',
                    headers: {
                        'apikey': KEY,
                        'Authorization': `Bearer ${KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify(saveData)
                });

                console.log('POST response status:', res.status);

                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('Supabase error:', res.status, res.statusText, errorText);
                    return false;
                }
                return true;
            } catch (e) {
                console.error('Connection error:', e);
                return false;
            }
        }

        // Delete data from Supabase
        async function deleteData(subjectId) {
            try {
                console.log('Deleting:', subjectId);
                const res = await fetch(`${URL}/rest/v1/logs?session_id=eq.${subjectId}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': KEY,
                        'Authorization': `Bearer ${KEY}`
                    }
                });

                console.log('Delete response:', res.status);
                if (!res.ok && res.status !== 404) {
                    const errorText = await res.text();
                    console.error('Supabase delete error:', res.status, errorText);
                    return false;
                }
                return true;
            } catch (e) {
                console.error('Delete connection error:', e);
                return false;
            }
        }

        // Helper function to parse time string to minutes
        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function getLostTargetDay() {
            if (selectedLostDay && selectedLostDay >= 1 && selectedLostDay <= 5) {
                return selectedLostDay;
            }
            if (currentMobileDay && currentMobileDay >= 1 && currentMobileDay <= 5) {
                return currentMobileDay;
            }
            const today = getCurrentDayWithOffset();
            return (today >= 1 && today <= 5) ? today : 1;
        }

        function getDayShortName(dayIndex) {
            return dayShortNames[dayIndex - 1] || 'MON';
        }

        function updateLostTargetButtons() {
            if (!lostTargetBtns.length) return;
            const targetDay = getLostTargetDay();
            lostTargetBtns.forEach(btn => {
                const day = parseInt(btn.dataset.lostDay, 10);
                if (day === targetDay) {
                    btn.classList.remove('bg-gray-700/50', 'text-gray-300', 'border-gray-600/60');
                    btn.classList.add('bg-blue-600', 'text-white', 'border-blue-400/70');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-400/70');
                    btn.classList.add('bg-gray-700/50', 'text-gray-300', 'border-gray-600/60');
                }
            });
        }

        function updateLostButtonState() {
            const targetDay = getLostTargetDay();
            const lostButtons = [lostDayBtn, lostDayBtnDesktop].filter(Boolean);

            if (!lostButtons.length) return;

            lostButtons.forEach(btn => {
                btn.disabled = isApplyingLost;
                btn.classList.toggle('opacity-60', isApplyingLost);
                btn.textContent = isApplyingLost ? `MARKING ${getDayShortName(targetDay)}...` : `LOST (${getDayShortName(targetDay)})`;
            });
        }

        window.setLostTargetDay = function(dayIndex) {
            if (dayIndex < 1 || dayIndex > 5) return;
            selectedLostDay = dayIndex;
            updateLostTargetButtons();
            updateLostButtonState();
        }

        function closeLostWarningModal() {
            lostWarnModal.classList.remove('visible-element');
            lostWarnModal.classList.add('hidden-element');
            lostWarningDay = null;
            lostReadyAt = 0;
            if (lostReadyTimer) {
                clearInterval(lostReadyTimer);
                lostReadyTimer = null;
            }
        }

        function updateLostWarningCountdown() {
            if (!lostWarningDay) return;
            const remainingMs = Math.max(0, lostReadyAt - Date.now());
            const secondsLeft = Math.ceil(remainingMs / 1000);

            if (remainingMs > 0) {
                lostWarnCountdown.textContent = `Please wait ${secondsLeft}s before confirming.`;
                lostWarnConfirmBtn.disabled = true;
                lostWarnConfirmBtn.classList.add('opacity-60');
                lostWarnConfirmBtn.textContent = `Confirm in ${secondsLeft}s`;
                return;
            }

            lostWarnCountdown.textContent = 'Ready. Click confirm to apply LOST.';
            lostWarnConfirmBtn.disabled = false;
            lostWarnConfirmBtn.classList.remove('opacity-60');
            lostWarnConfirmBtn.textContent = 'Confirm LOST';
            if (lostReadyTimer) {
                clearInterval(lostReadyTimer);
                lostReadyTimer = null;
            }
        }

        function openLostWarningModal(dayIndex) {
            const dayLabel = getDayShortName(dayIndex);
            lostWarningDay = dayIndex;
            lostReadyAt = Date.now() + 2000;
            lostWarnText.textContent = `You are about to mark every subject on ${dayLabel} as LOST (red).`;
            lostWarnModal.classList.remove('hidden-element');
            lostWarnModal.classList.add('visible-element');
            updateLostWarningCountdown();

            if (lostReadyTimer) clearInterval(lostReadyTimer);
            lostReadyTimer = setInterval(updateLostWarningCountdown, 100);
        }

        async function applyLostToDay(dayIndex) {
            const periodsToUpdate = timePeriods.filter(period => getSubjectNameForDay(period, dayIndex) !== '---');
            const saveJobs = periodsToUpdate.map(period => {
                const subjectId = getSubjectId(dayIndex, period.period);
                const existing = cachedData[subjectId];
                const content = (existing && typeof existing.content === 'string') ? existing.content : '';
                return saveData(subjectId, content, dayIndex, period.period, 'lost');
            });
            const results = await Promise.all(saveJobs);
            return results.every(Boolean);
        }

        window.handleLostDayAction = async function() {
            const dayIndex = getLostTargetDay();
            openLostWarningModal(dayIndex);
        };

        lostWarnCancelBtn.onclick = () => {
            closeLostWarningModal();
        };

        lostWarnModal.onclick = (e) => {
            if (e.target === lostWarnModal) {
                closeLostWarningModal();
            }
        };

        lostWarnConfirmBtn.onclick = async () => {
            if (!lostWarningDay || Date.now() < lostReadyAt || isApplyingLost) return;

            const dayIndex = lostWarningDay;
            const dayLabel = getDayShortName(dayIndex);
            closeLostWarningModal();

            isApplyingLost = true;
            updateLostButtonState();

            const success = await applyLostToDay(dayIndex);

            isApplyingLost = false;
            updateLostButtonState();

            if (!success) {
                alert(`Failed to mark ${dayLabel} as LOST. Please check your network and try again.`);
                return;
            }

            successText.textContent = `${dayLabel} LOST`;
            successToast.classList.remove('hidden-element');
            successToast.classList.add('visible-element');

            await renderTimetable();

            setTimeout(() => {
                successText.textContent = 'SUCCESS';
                successToast.classList.remove('visible-element');
                successToast.classList.add('hidden-element');
            }, 1000);
        };

        // Show mobile day view
        function showDay(dayIndex) {
            const dayNames = ['MON', 'TUE', 'WED', 'THU', 'FRI'];
            const dayNamesZH = ['ÊòüÊúü‰∏Ä', 'ÊòüÊúü‰∫å', 'ÊòüÊúü‰∏â', 'ÊòüÊúüÂõõ', 'ÊòüÊúü‰∫î'];
            const dayNamesFull = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            
            currentMobileDay = dayIndex;
            selectedLostDay = dayIndex;
            updateLostTargetButtons();
            updateLostButtonState();
            dayViewTitle.textContent = `${dayNamesZH[dayIndex - 1]} (${dayNamesFull[dayIndex - 1]})`;
            
            // Update day buttons
            document.querySelectorAll('.day-btn').forEach(btn => {
                if (parseInt(btn.dataset.day) === dayIndex) {
                    btn.classList.remove('bg-gray-700/50', 'text-gray-400');
                    btn.classList.add('bg-blue-600', 'text-white');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-700/50', 'text-gray-400');
                }
            });

            // Generate day content
            dayViewContent.innerHTML = '';
            
            const dayPeriods = timePeriods.filter(p => getSubjectNameForDay(p, dayIndex) !== '---');
            const isToday = dayIndex === getCurrentDayWithOffset();

            dayPeriods.forEach(period => {
                const subjectName = getSubjectNameForDay(period, dayIndex);
                const subjectId = getSubjectId(dayIndex, period.period);
                const record = cachedData[subjectId];
                const hasContent = record && record.content && record.content.trim();
                const status = record?.status || '';

                let statusClass = 'subject-gray';
                let statusText = '‚óã';
                
                if (status === 'lost') {
                    statusClass = 'text-red-400';
                    statusText = 'LOST';
                } else if (status === 'miss') {
                    statusClass = 'text-red-400';
                    statusText = 'MISS';
                } else if (status === 'holiday') {
                    statusClass = 'text-green-400';
                    statusText = 'HOLIDAY';
                } else if (hasContent) {
                    statusClass = 'subject-green';
                    statusText = '‚úì';
                }

                const div = document.createElement('div');
                div.className = `panel rounded-xl p-3 sm:p-4 touch-optimized ${isToday ? 'today' : ''}`;
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="subject-time text-gray-400">${period.time} ‚Ä¢ Á¨¨${period.period}ÁØÄ</div>
                            <div class="subject-name ${statusClass} mt-1">${subjectName}</div>
                            <div class="subject-status ${statusClass} mt-0.5">${statusText}</div>
                            ${hasContent ? `<div class="text-sm text-gray-300 mt-2 line-clamp-2">${record.content}</div>` : ''}
                        </div>
                        <button onclick="openEditModal(${dayIndex}, ${period.period}, '${subjectName}')" 
                            class="ml-2 px-3 py-1.5 bg-blue-600/30 hover:bg-blue-600/50 rounded-lg text-sm text-blue-400 touch-optimized">
                            Á∑®ËºØ
                        </button>
                    </div>
                `;
                dayViewContent.appendChild(div);
            });

            dayViewModal.classList.remove('hidden-element');
            dayViewModal.classList.add('visible-element');
        }

        // Close day view modal
        function closeDayView() {
            dayViewModal.classList.remove('visible-element');
            dayViewModal.classList.add('hidden-element');
            currentMobileDay = null;
        }

        // Open changelog modal
        window.openChangelog = function() {
            const changelogModal = document.getElementById('changelogModal');
            changelogModal.classList.remove('hidden-element');
            changelogModal.classList.add('visible-element');
        }

        // Close changelog modal
        window.closeChangelog = function() {
            const changelogModal = document.getElementById('changelogModal');
            changelogModal.classList.remove('visible-element');
            changelogModal.classList.add('hidden-element');
        }

        // Render the timetable
        async function renderTimetable() {
            cachedData = await loadData();
            timetableBody.innerHTML = '';

            const allRows = [];
            
            // Add day-specific break rows (merge same time/label into one row)
            const mergedDayBreaks = new Map();
            daySpecificBreaks.forEach(row => {
                const key = `${row.time}|${row.label}`;
                if (!mergedDayBreaks.has(key)) {
                    mergedDayBreaks.set(key, {
                        time: row.time,
                        label: row.label,
                        days: row.days ? [...row.days] : [],
                        spans: row.spans ? [...row.spans] : []
                    });
                    return;
                }

                const existing = mergedDayBreaks.get(key);
                if (row.days && row.days.length) {
                    existing.days = Array.from(new Set([...existing.days, ...row.days])).sort((a, b) => a - b);
                }
                if (row.spans && row.spans.length) {
                    existing.spans.push(...row.spans);
                }
            });

            mergedDayBreaks.forEach(row => {
                const startTime = row.time.split('-')[0];
                allRows.push({
                    type: 'break',
                    time: row.time,
                    label: row.label,
                    merged: false,
                    days: row.days || [],
                    spans: row.spans && row.spans.length ? row.spans : null,
                    startTime: parseTime(startTime)
                });
            });
            
            // Add merged break rows
            specialRows.forEach(row => {
                const startTime = row.time.split('-')[0];
                allRows.push({
                    type: 'break',
                    time: row.time,
                    label: row.label,
                    merged: true,
                    days: [1, 2, 3, 4, 5],
                    startTime: parseTime(startTime)
                });
            });

            // Add period rows
            timePeriods.forEach(period => {
                const startTime = period.time.split('-')[0];
                allRows.push({
                    type: 'period',
                    time: period.time,
                    period: period.period,
                    subjects: period.subjects,
                    startTime: parseTime(startTime)
                });
            });

            // Sort by start time and dedupe break rows by time+label
            allRows.sort((a, b) => a.startTime - b.startTime);
            const seenBreakKeys = new Set();
            const dedupedRows = [];
            allRows.forEach(r => {
                if (r.type === 'break' && !r.merged) {
                    const k = `${r.time}|${r.label}`;
                    if (seenBreakKeys.has(k)) return;
                    seenBreakKeys.add(k);
                }
                dedupedRows.push(r);
            });

            // Render all rows
            dedupedRows.forEach(row => {
                if (row.type === 'break' && row.merged) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-1 sm:p-2 text-left text-white text-xs opacity-60">${row.time}</td>
                        <td colspan="5" class="p-1 sm:p-2 text-center text-white text-xs sm:text-sm font-light opacity-50">${row.label}</td>
                    `;
                    timetableBody.appendChild(tr);
                } else if (row.type === 'break' && !row.merged) {
                    const tr = document.createElement('tr');
                    let cellsHTML = '';
                    // At 16:10-16:15, Wed is occupied by period-8 leisure rowspan.
                    // Do not emit an extra Wed placeholder cell in that case.
                    const wedOccupiedByRowspan = row.time === '16:10-16:15'
                        && getSubjectNameForDay(timePeriods.find(p => p.period === 8), 3) === 'È§òÊöáÊ¥ªÂãï';

                    if (row.spans && row.spans.length) {
                        let cursor = 1;
                        const sortedSpans = [...row.spans].sort((a, b) => a.start - b.start);
                        sortedSpans.forEach(span => {
                            while (cursor < span.start) {
                                if (!(wedOccupiedByRowspan && cursor === 3)) {
                                    cellsHTML += `<td class="p-1 sm:p-2 border border-transparent"></td>`;
                                }
                                cursor++;
                            }

                            const colspan = span.end - span.start + 1;
                            cellsHTML += `<td colspan="${colspan}" class="p-1 sm:p-2 text-center text-white text-xs sm:text-sm font-light opacity-50 border border-gray-700/50 rounded-lg">${row.label}</td>`;
                            cursor = span.end + 1;
                        });

                        while (cursor <= 5) {
                            if (!(wedOccupiedByRowspan && cursor === 3)) {
                                cellsHTML += `<td class="p-1 sm:p-2 border border-transparent"></td>`;
                            }
                            cursor++;
                        }
                    } else {
                        for (let dayIndex = 1; dayIndex <= 5; dayIndex++) {
                            if (wedOccupiedByRowspan && dayIndex === 3) continue;
                            if (row.days.includes(dayIndex)) {
                                cellsHTML += `<td class="p-1 sm:p-2 text-center text-white text-xs sm:text-sm font-light opacity-50 border border-gray-700/50 rounded-lg">${row.label}</td>`;
                            } else {
                                cellsHTML += `<td class="p-1 sm:p-2 border border-transparent"></td>`;
                            }
                        }
                    }
                    
                    tr.innerHTML = `
                        <td class="p-1 sm:p-2 text-left text-white text-xs opacity-60">${row.time}</td>
                        ${cellsHTML}
                    `;
                    timetableBody.appendChild(tr);
                } else {
                    const tr = document.createElement('tr');
                    
                    // Time column
                    const timeTd = document.createElement('td');
                    timeTd.className = 'p-1 sm:p-2 text-left text-white text-xs whitespace-nowrap';
                    timeTd.style.fontFamily = "'KaiTi', 'STKaiti', 'Ê®ôÊ•∑È´î', serif";
                    timeTd.innerHTML = `${row.time}<br><span class="text-white opacity-50 text-xs">Á¨¨${row.period}ÁØÄ</span>`;
                    tr.appendChild(timeTd);

                    // Day columns (1-5 = Mon-Fri)
                    for (let dayIndex = 1; dayIndex <= 5; dayIndex++) {
                        const subjectName = getSubjectNameForDay(row, dayIndex);
                        
                        const shouldMerge = row.period === 8 && dayIndex === 3;

                        // Skip Wednesday period 9 if period 8 had a merged leisure cell spanning into it
                        if (dayIndex === 3 && row.period === 9) continue;
                        
                        const subjectId = getSubjectId(dayIndex, row.period);
                        const record = cachedData[subjectId];
                        const hasContent = record && record.content && record.content.trim();
                        const status = record?.status || '';
                        const isToday = dayIndex === getCurrentDayWithOffset();
                        
                        const cell = document.createElement('td');
                        cell.className = `p-0.5 sm:p-1 timetable-cell border border-gray-700/50 rounded-lg ${isToday ? 'today' : ''}`;
                        if (shouldMerge) {
                            cell.setAttribute('rowspan', '2');
                        }
                        
                        const isUnclickable = subjectName === '---';

                        let statusClass = 'subject-gray';
                        let statusText = '‚óã';
                        
                        if (!isUnclickable) {
                            if (status === 'lost') {
                                statusClass = 'text-red-400';
                                statusText = 'LOST';
                            } else if (status === 'miss') {
                                statusClass = 'text-red-400';
                                statusText = 'MISS';
                            } else if (status === 'holiday') {
                                statusClass = 'text-green-400';
                                statusText = 'HOLIDAY';
                            } else if (hasContent) {
                                statusClass = 'subject-green';
                                statusText = '‚úì';
                            }
                        }

                        // Render merged ‰ΩôÊöáÊ¥ªÂãï cell with proper centering
                        if (shouldMerge) {
                            const bgStyle = hasContent ? `background-image: url('https://raw.githubusercontent.com/x8lua/CRlogger/main/assets/tick.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat; opacity: 0.5;` : '';
                            cell.innerHTML = `
                                <div class="leisure-cell cursor-pointer hover:bg-white/10 transition-all" style="position: relative;"
                                    onclick="openEditModal(${dayIndex}, ${row.period}, '${subjectName}')">
                                    ${hasContent ? `<div style="position: absolute; inset: 0; ${bgStyle} pointer-events: none;"></div>` : ''}
                                    <div class="text-center" style="position: relative; z-index: 1;">
                                        <div class="subject-name ${statusClass}">${subjectName}</div>
                                    </div>
                                </div>
                            `;
                        } else if (isUnclickable) {
                            cell.innerHTML = `
                                <div class="text-center p-1 opacity-30">
                                    <div class="subject-name text-white">${subjectName}</div>
                                </div>
                            `;
                        } else {
                            const bgStyle = hasContent ? `background-image: url('https://raw.githubusercontent.com/x8lua/CRlogger/main/assets/tick.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat; opacity: 0.5;` : '';
                            cell.innerHTML = `
                                <div class="text-center p-1 cursor-pointer hover:bg-white/10 rounded-lg transition-all" style="position: relative;"
                                    onclick="openEditModal(${dayIndex}, ${row.period}, '${subjectName}')">
                                    ${hasContent ? `<div style="position: absolute; inset: 0; ${bgStyle} pointer-events: none;"></div>` : ''}
                                    <div style="position: relative; z-index: 1;">
                                        <div class="subject-name ${statusClass}">${subjectName}</div>
                                        <div class="subject-status ${statusClass} mt-0.5 hidden sm:block">${statusText}</div>
                                    </div>
                                </div>
                            `;
                        }
                        tr.appendChild(cell);
                    }

                    timetableBody.appendChild(tr);
                }
            });

            // Update mobile day selector
            if (isMobile() && currentMobileDay) {
                showDay(currentMobileDay);
            }
            updateLostTargetButtons();
            updateLostButtonState();
        }

        // Open edit modal
        window.openEditModal = async function(dayIndex, period, subjectName) {
            const dayNames = ['MON', 'TUE', 'WED', 'THU', 'FRI'];
            const dayNamesZH = ['ÊòüÊúü‰∏Ä', 'ÊòüÊúü‰∫å', 'ÊòüÊúü‰∏â', 'ÊòüÊúüÂõõ', 'ÊòüÊúü‰∫î'];
            
            editingSubject = { dayIndex, period, subjectName };
            deleteClicks = 0;
            currentStatus = '';
            
            const data = await loadData();
            const subjectId = getSubjectId(dayIndex, period);
            const record = data[subjectId];
            const hasContent = record && record.content && record.content.trim();

            editTitle.textContent = subjectName;
            editSubject.textContent = `${dayNamesZH[dayIndex - 1]} (${dayNames[dayIndex - 1]}) - Á¨¨ ${period} ÁØÄ`;
            editBox.value = hasContent ? record.content : '';
            
            currentStatus = record?.status || '';
            updateStatusButtons();

            if (hasContent || currentStatus) {
                editDelete.classList.remove('hidden');
                deleteCounter.classList.add('hidden');
            } else {
                editDelete.classList.add('hidden');
                deleteCounter.classList.add('hidden');
            }
            
            editMsg.innerText = '';
            editModal.classList.remove('hidden-element');
            editModal.classList.add('visible-element');
            editBox.focus();
        };

        // Update status buttons appearance
        function updateStatusButtons() {
            if (currentStatus === 'miss' || currentStatus === 'lost') {
                btnMiss.className = 'w-full py-2.5 sm:py-3 rounded-xl border-2 border-black bg-black text-white transition-all text-sm sm:text-base font-bold';
            } else {
                btnMiss.className = 'w-full py-2.5 sm:py-3 rounded-xl border-2 border-black bg-white text-black transition-all text-sm sm:text-base font-bold';
            }
        }

        // Status button handlers
        btnMiss.onclick = () => {
            currentStatus = (currentStatus === 'miss' || currentStatus === 'lost') ? '' : 'miss';
            updateStatusButtons();
        };

        // Close edit modal
        function closeEditModal() {
            editModal.classList.remove('visible-element');
            editModal.classList.add('hidden-element');
            editingSubject = null;
            deleteClicks = 0;
        }

        editClose.onclick = closeEditModal;

        // Close modal on outside click
        editModal.onclick = (e) => {
            if (e.target === editModal) closeEditModal();
        };

        // Close modal on Escape
        document.onkeydown = (e) => {
            if (e.key === 'Escape') {
                closeEditModal();
                closeDayView();
                closeLostWarningModal();
            }
        };

        // Confirm / Submit
        editConfirm.onclick = async () => {
            const content = editBox.value.trim();
            const { dayIndex, period, subjectName } = editingSubject;
            const subjectId = getSubjectId(dayIndex, period);

            if (!content && !currentStatus) {
                editMsg.innerText = "Ë´ãËº∏ÂÖ•ÂÖßÂÆπÊàñÈÅ∏Êìá MISS";
                return;
            }

            editConfirm.disabled = true;
            editConfirm.classList.add('opacity-50');
            editMsg.innerText = "üì° Uplinking...";

            try {
                const success = await saveData(subjectId, content, dayIndex, period, currentStatus);
                if (success) {
                    editMsg.innerText = "‚ú® SUCCESS";
                    editConfirm.disabled = false;
                    editConfirm.classList.remove('opacity-50');

                    successText.textContent = 'SUCCESS';
                    successToast.classList.remove('hidden-element');
                    successToast.classList.add('visible-element');

                    setTimeout(() => {
                        closeEditModal();
                        successToast.classList.remove('visible-element');
                        successToast.classList.add('hidden-element');
                        renderTimetable();
                    }, 1000);
                } else {
                    editMsg.innerText = "‚ùå ÂÑ≤Â≠òÂ§±Êïó - Ë´ãÊ™¢Êü•Á∂≤Áµ°";
                    editConfirm.disabled = false;
                    editConfirm.classList.remove('opacity-50');
                }
            } catch (e) {
                editMsg.innerText = "‚ùå ÈÄ£Êé•Â§±Êïó - Ë´ãÊ™¢Êü•Á∂≤Áµ°";
                editConfirm.disabled = false;
                editConfirm.classList.remove('opacity-50');
            }
        };

        // Delete button click
        editDelete.onclick = () => {
            deleteClicks++;
            deleteCounter.classList.remove('hidden');
            deleteCounter.textContent = `Click ${deleteClicks}/3 to delete`;
            editDelete.classList.add('delete-pulse');
            
            setTimeout(() => editDelete.classList.remove('delete-pulse'), 500);

            if (deleteClicks >= 3) {
                deleteSubject();
            }
        };

        // Delete subject
        async function deleteSubject() {
            const { dayIndex, period } = editingSubject;
            const subjectId = getSubjectId(dayIndex, period);
            
            editDelete.disabled = true;
            editDelete.classList.add('opacity-50');
            editMsg.innerText = "üóëÔ∏è Deleting...";

            try {
                const success = await deleteData(subjectId);
                if (success) {
                    editMsg.innerText = "‚ú® DELETED";
                    
                    successText.textContent = 'DELETED';
                    successToast.classList.remove('hidden-element');
                    successToast.classList.add('visible-element');
                    
                    setTimeout(() => {
                        closeEditModal();
                        successText.textContent = 'SUCCESS';
                        successToast.classList.remove('visible-element');
                        successToast.classList.add('hidden-element');
                        renderTimetable();
                    }, 1000);
                } else {
                    editMsg.innerText = "‚ùå Âà™Èô§Â§±Êïó - Ë´ãÊ™¢Êü•Á∂≤Áµ°";
                    deleteClicks = 0;
                    deleteCounter.classList.add('hidden');
                    editDelete.disabled = false;
                    editDelete.classList.remove('opacity-50');
                }
            } catch (e) {
                editMsg.innerText = "‚ùå ÈÄ£Êé•Â§±Êïó - Ë´ãÊ™¢Êü•Á∂≤Áµ°";
                deleteClicks = 0;
                deleteCounter.classList.add('hidden');
                editDelete.disabled = false;
                editDelete.classList.remove('opacity-50');
            }
        }

        // Click anywhere to show timetable
        document.body.onclick = (e) => {
            if (e.target.closest('#editModal')) return;
            if (e.target.closest('.timetable-cell')) return;
            if (e.target.closest('#dayViewModal')) return;

            if (!mainContent.classList.contains('visible-element')) {
                logoContainer.classList.add('fade-out');
                setTimeout(() => {
                    logoContainer.classList.add('hidden-element');
                    mainContent.classList.remove('hidden-element');
                    mainContent.classList.add('visible-element');
                }, 300);
            }
        };

        // Handle window resize
        window.addEventListener('resize', () => {
            if (isMobile() && currentMobileDay) {
                showDay(currentMobileDay);
            }
        });

        // Initial render
        const initialLostDay = getCurrentDayWithOffset();
        selectedLostDay = (initialLostDay >= 1 && initialLostDay <= 5) ? initialLostDay : 1;
        updateLostTargetButtons();
        updateLostButtonState();
        updateWeekLabel();
        renderTimetable();
    </script>
</body>
</html>
